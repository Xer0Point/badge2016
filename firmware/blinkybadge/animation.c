/*
* animation.c
*
* Created: 7/26/2016 2:50:36 PM
*  Author: supersat
*/

#include "blinkybadge.h"
#include "animation.h"
#include "ws2812.h"
#include <avr/pgmspace.h>

static uint32_t nextFrameTime;
uint8_t currentAnimation;
static uint16_t currentFrame;
static uint16_t endFrame;

static const uint8_t PROGMEM animationData[] = {
	0x0c, 0x00, 0x08, 0x00,
	0xdc, 0x00, 0x10, 0x00,
	0x00, 0x00, 0x00, 0x00,
	
	0x00, 0xff, 0x00, //red
	0xa5, 0xff, 0x00, //orange
	0xff, 0xff, 0x00, //yellow
	0xff, 0x00, 0x00, //green
	0xff, 0x00, 0xff, //aqua
	0x00, 0x00, 0xff, //blue
	0x00, 0x80, 0x80, //purple
	0x00, 0xff, 0xff, //pink
	0x96, 0x00,       //time
	
	0xa5, 0xff, 0x00, //orange
	0xff, 0xff, 0x00, //yellow
	0xff, 0x00, 0x00, //green
	0xff, 0x00, 0xff, //aqua
	0x00, 0x00, 0xff, //blue
	0x00, 0x80, 0x80, //purple
	0x00, 0xff, 0xff, //pink
	0x00, 0xff, 0x00, //red
	0x96, 0x00,

	0xff, 0xff, 0x00, //yellow
	0xff, 0x00, 0x00, //green
	0xff, 0x00, 0xff, //aqua
	0x00, 0x00, 0xff, //blue
	0x00, 0x80, 0x80, //purple
	0x00, 0xff, 0xff, //pink
	0x00, 0xff, 0x00, //red
	0xa5, 0xff, 0x00, //orange
	0x96, 0x00,

	0xff, 0x00, 0x00, //green
	0xff, 0x00, 0xff, //aqua
	0x00, 0x00, 0xff, //blue
	0x00, 0x80, 0x80, //purple
	0x00, 0xff, 0xff, //pink
	0x00, 0xff, 0x00, //red
	0xa5, 0xff, 0x00, //orange
	0xff, 0xff, 0x00, //yellow
	0x96, 0x00,

	0xff, 0x00, 0xff, //aqua
	0x00, 0x00, 0xff, //blue
	0x00, 0x80, 0x80, //purple
	0x00, 0xff, 0xff, //pink
	0x00, 0xff, 0x00, //red
	0xa5, 0xff, 0x00, //orange
	0xff, 0xff, 0x00, //yellow
	0xff, 0x00, 0x00, //green
	0x96, 0x00,
	
	0x00, 0x00, 0xff, //blue
	0x00, 0x80, 0x80, //purple
	0x00, 0xff, 0xff, //pink
	0x00, 0xff, 0x00, //red
	0xa5, 0xff, 0x00, //orange
	0xff, 0xff, 0x00, //yellow
	0xff, 0x00, 0x00, //green
	0xff, 0x00, 0xff, //aqua
	0x96, 0x00,
	

	0x00, 0x80, 0x80, //purple
	0x00, 0xff, 0xff, //pink
	0x00, 0xff, 0x00, //red
	0xa5, 0xff, 0x00, //orange
	0xff, 0xff, 0x00, //yellow
	0xff, 0x00, 0x00, //green
	0xff, 0x00, 0xff, //aqua
	0x00, 0x00, 0xff, //blue
	0x96, 0x00,

	0x00, 0xff, 0xff, //pink
	0x00, 0xff, 0x00, //red
	0xa5, 0xff, 0x00, //orange
	0xff, 0xff, 0x00, //yellow
	0xff, 0x00, 0x00, //green
	0xff, 0x00, 0xff, //aqua
	0x00, 0x00, 0xff, //blue
	0x00, 0x80, 0x80, //purple
	0x96, 0x00,
	
	//
	
	0x00, 0xff, 0x00,
	0x00, 0x80, 0x00,
	0x00, 0x40, 0x00,
	0x00, 0x20, 0x00,
	0x00, 0x10, 0x00,
	0x00, 0x08, 0x00,
	0x00, 0x04, 0x00,
	0x00, 0x02, 0x00,
	0x32, 0x00,
	
	0x00, 0x80, 0x00,
	0x00, 0x40, 0x00,
	0x00, 0x20, 0x00,
	0x00, 0x10, 0x00,
	0x00, 0x08, 0x00,
	0x00, 0x04, 0x00,
	0x00, 0x02, 0x00,
	0x00, 0xff, 0x00,
	0x32, 0x00,
	
	0x00, 0x40, 0x00,
	0x00, 0x20, 0x00,
	0x00, 0x10, 0x00,
	0x00, 0x08, 0x00,
	0x00, 0x04, 0x00,
	0x00, 0x02, 0x00,
	0x00, 0xff, 0x00,
	0x00, 0x80, 0x00,
	0x32, 0x00,
	
	0x00, 0x20, 0x00,
	0x00, 0x10, 0x00,
	0x00, 0x08, 0x00,
	0x00, 0x04, 0x00,
	0x00, 0x02, 0x00,
	0x00, 0xff, 0x00,
	0x00, 0x80, 0x00,
	0x00, 0x40, 0x00,
	0x32, 0x00,
	
	0x00, 0x10, 0x00,
	0x00, 0x08, 0x00,
	0x00, 0x04, 0x00,
	0x00, 0x02, 0x00,
	0x00, 0xff, 0x00,
	0x00, 0x80, 0x00,
	0x00, 0x40, 0x00,
	0x00, 0x20, 0x00,
	0x32, 0x00,
	
	0x00, 0x08, 0x00,
	0x00, 0x04, 0x00,
	0x00, 0x02, 0x00,
	0x00, 0xff, 0x00,
	0x00, 0x80, 0x00,
	0x00, 0x40, 0x00,
	0x00, 0x20, 0x00,
	0x00, 0x10, 0x00,
	0x32, 0x00,
	
	0x00, 0x04, 0x00,
	0x00, 0x02, 0x00,
	0x00, 0xff, 0x00,
	0x00, 0x80, 0x00,
	0x00, 0x40, 0x00,
	0x00, 0x20, 0x00,
	0x00, 0x10, 0x00,
	0x00, 0x08, 0x00,
	0x32, 0x00,
	
	0x00, 0x02, 0x00,
	0x00, 0xff, 0x00,
	0x00, 0x80, 0x00,
	0x00, 0x40, 0x00,
	0x00, 0x20, 0x00,
	0x00, 0x10, 0x00,
	0x00, 0x08, 0x00,
	0x00, 0x04, 0x00,
	0x32, 0x00,
	
	//
	0xff, 0x00, 0x00,
	0x80, 0x00, 0x00,
	0x40, 0x00, 0x00,
	0x20, 0x00, 0x00,
	0x10, 0x00, 0x00,
	0x08, 0x00, 0x00,
	0x04, 0x00, 0x00,
	0x02, 0x00, 0x00,
	0x32, 0x00,
	
	0x80, 0x00, 0x00,
	0x40, 0x00, 0x00,
	0x20, 0x00, 0x00,
	0x10, 0x00, 0x00,
	0x08, 0x00, 0x00,
	0x04, 0x00, 0x00,
	0x02, 0x00, 0x00,
	0xff, 0x00, 0x00,
	0x32, 0x00,
	
	0x40, 0x00, 0x00,
	0x20, 0x00, 0x00,
	0x10, 0x00, 0x00,
	0x08, 0x00, 0x00,
	0x04, 0x00, 0x00,
	0x02, 0x00, 0x00,
	0xff, 0x00, 0x00,
	0x80, 0x00, 0x00,
	0x32, 0x00,
	
	0x20, 0x00, 0x00,
	0x10, 0x00, 0x00,
	0x08, 0x00, 0x00,
	0x04, 0x00, 0x00,
	0x02, 0x00, 0x00,
	0xff, 0x00, 0x00,
	0x80, 0x00, 0x00,
	0x40, 0x00, 0x00,
	0x32, 0x00,
	
	0x10, 0x00, 0x00,
	0x08, 0x00, 0x00,
	0x04, 0x00, 0x00,
	0x02, 0x00, 0x00,
	0xff, 0x00, 0x00,
	0x80, 0x00, 0x00,
	0x40, 0x00, 0x00,
	0x20, 0x00, 0x00,
	0x32, 0x00,
	
	0x08, 0x00, 0x00,
	0x04, 0x00, 0x00,
	0x02, 0x00, 0x00,
	0xff, 0x00, 0x00,
	0x80, 0x00, 0x00,
	0x40, 0x00, 0x00,
	0x20, 0x00, 0x00,
	0x10, 0x00, 0x00,
	0x32, 0x00,
	
	0x04, 0x00, 0x00,
	0x02, 0x00, 0x00,
	0xff, 0x00, 0x00,
	0x80, 0x00, 0x00,
	0x40, 0x00, 0x00,
	0x20, 0x00, 0x00,
	0x10, 0x00, 0x00,
	0x08, 0x00, 0x00,
	0x32, 0x00,
	
	0x02, 0x00, 0x00,
	0xff, 0x00, 0x00,
	0x80, 0x00, 0x00,
	0x40, 0x00, 0x00,
	0x20, 0x00, 0x00,
	0x10, 0x00, 0x00,
	0x08, 0x00, 0x00,
	0x04, 0x00, 0x00,
	0x32, 0x00,
	
	
};

static void loadFrame();
void beginAnimation();

uint8_t ledData[24];

void loadFrame()
{
	if (currentFrame == endFrame) {
		beginAnimation();
	} else {
		memcpy_P(ledData, (void * PROGMEM)currentFrame, sizeof(ledData));
		nextFrameTime = get_ms() + pgm_read_word(currentFrame + sizeof(ledData));
		currentFrame += sizeof(frame_t);
		updateLEDs(ledData, sizeof(ledData));
	}
}

void beginAnimation()
{
	currentFrame = (uint16_t)animationData + pgm_read_word(animationData + currentAnimation * sizeof(animation_t));
	endFrame = currentFrame + pgm_read_word(animationData + currentAnimation * sizeof(animation_t) + 2) * sizeof(frame_t);
	loadFrame();
}

void animationTick()
{
	if (get_ms() >= nextFrameTime) {
		loadFrame();
	}
}

void initAnimation()
{
	currentAnimation = 0;
	beginAnimation();
}